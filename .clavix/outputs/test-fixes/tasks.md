# Implementation Plan

**Project**: test-fixes
**Generated**: 2025-01-17T23:00:00Z
**Purpose**: Fix all failing tests in the monorepo

## Technical Context & Standards

*Detected Stack & Patterns*
- **Backend**: NestJS with Jest, TypeORM, PostgreSQL
- **Frontend**: React with Vite, Playwright E2E tests
- **Testing**: Jest (backend), Vitest (frontend unit), Playwright (E2E)
- **Conventions**:
  - Test files co-located with source: `*.spec.ts`
  - E2E tests in `apps/frontend/e2e/tests/`
  - Fixtures in `apps/frontend/e2e/fixtures/`

---

## Phase 1: Frontend E2E - Critical Syntax Errors (High Priority)

*Fixes that unblock 13 tests in ~3 minutes*

- [x] **Fix circular reference in test-fixtures.ts**
  Task ID: phase-1-frontend-01
  > **Implementation**: Edit `apps/frontend/e2e/fixtures/test-fixtures.ts` line 37.
  > **Details**: Delete the redundant line `export const E2E_CASH_REGISTER = E2E_CASH_REGISTER;` at line 37. This creates a circular reference where `TEST_CASH_REGISTER` (line 35) tries to use `E2E_CASH_REGISTER` before it's declared. The value is already imported from `./test-data.ts` at line 9, so line 37 is completely unnecessary.

- [x] **Fix missing closing parenthesis in customer-accounts.spec.ts**
  Task ID: phase-1-frontend-02
  > **Implementation**: Edit `apps/frontend/e2e/tests/customer-accounts.spec.ts` line 97.
  > **Details**: Change `.or(page.getByRole('button', { name: /Pago/i });` to `.or(page.getByRole('button', { name: /Pago/i }));` - add the missing closing parenthesis before the semicolon.

- [x] **Fix missing closing parenthesis in incomes.spec.ts**
  Task ID: phase-1-frontend-03
  > **Implementation**: Edit `apps/frontend/e2e/tests/incomes.spec.ts` line 20.
  > **Details**: The line has unbalanced parentheses. Change:
  ```typescript
  await expect(page.getByRole('button', { name: /Nuevo Ingreso/i }).or(page.getByRole('button', { name: /Nuevo/i })).toBeVisible();
  ```
  To:
  ```typescript
  await expect(page.getByRole('button', { name: /Nuevo Ingreso/i }).or(page.getByRole('button', { name: /Nuevo/i }))).toBeVisible();
  ```
  Note: The `.or()` chain needs to close before `.toBeVisible()`.

---

## Phase 2: Backend Unit Tests - Mock Configuration (Medium Priority)

*Fixes 5 failing sales tests*

- [x] **Fix findOne mock timing in sales.service.spec.ts**
  Task ID: phase-2-backend-01
  > **Implementation**: Edit `apps/backend/src/modules/sales/sales.service.spec.ts`.
  > **Details**: The issue is in tests for `create()` method. When `create()` calls `updateInventoryFromSale(saleId)`, that method calls `this.findOne(saleId)` but the mock isn't returning the created sale.
  >
  > For each affected test (around line 419, 452, 506, 567):
  > 1. Find where `queryRunner.manager.findOne.mockResolvedValue(mockCompletedSale)` is set
  > 2. Also add a mock for `salesService.findOne` to return the mock sale:
  > ```typescript
  > jest.spyOn(service, 'findOne').mockResolvedValue(mockCompletedSale as any);
  > ```
  >
  > Or alternatively, adjust the mock setup order to ensure `findOne` returns the sale before `create()` is called.

---

## Phase 3: Backend Integration Tests - Configuration (Low Priority)

*Fixes 3 integration tests - may require more investigation*

- [ ] **Investigate and fix integration test configuration**
  Task ID: phase-3-integration-01
  > **Implementation**: Investigate and fix `apps/backend/test/integration/*.spec.ts`.
  > **Details**: The integration tests (`sales-cash-register.integration.spec.ts`, `incomes-expenses.integration.spec.ts`, `customer-accounts.integration.spec.ts`) are failing with `AggregateError` without clear details.
  >
  > Steps:
  > 1. Check `apps/backend/test/setup-integration.ts` for proper test database configuration
  > 2. Verify test database is running or configure in-memory SQLite for tests
  > 3. Check if fixtures are being loaded properly (see `test/factories/*.ts`)
  > 4. Run individual test with verbose output: `npm test -- sales-cash-register.integration.spec.ts --verbose`
  > 5. Apply fix based on findings (likely database connection or missing module imports)

---

## Verification Steps

After completing all phases:

1. **Run backend tests**: `cd apps/backend && npm test`
2. **Run frontend tests**: `cd apps/frontend && npm test`
3. **Verify all tests pass**: Expected 169+ passing tests
4. **Check test coverage**: Ensure no regressions in existing functionality

---

## Summary

| Phase | Tests Fixed | Est. Time | Priority |
|-------|-------------|-----------|----------|
| 1 - Frontend Syntax | 13 | ~3 min | ðŸ”´ High |
| 2 - Backend Mocks | 5 | ~10 min | ðŸŸ¡ Medium |
| 3 - Integration Config | 3 | ~30 min | ðŸŸ¢ Low |
| **Total** | **21** | **~43 min** | |

---

*Generated by Clavix /clavix:plan*
